https://cloud.tencent.com/developer/article/2327500

# 如何设计一个高并发系统（正文内容提取）
大家好，我是苏三，又跟大家见面了。

## 前言
“如何设计高并发系统”是高频面试题，面试官可从多维度考查技术广度与深度，本文将梳理高并发系统设计的关键要点。


## 1 页面静态化
高并发系统的页面需做**静态化设计**：若大量用户访问时页面均通过服务器动态渲染，会导致服务端压力过大，甚至页面无法正常加载。  
实现方式：使用`Freemarker`或`Velocity`模板引擎，以商城官网首页为例，通过`Job`定期查询首页所需数据，汇总后生成`html`文件，再通过`shell`脚本自动同步到前端服务器。


## 2 CDN加速
页面静态化虽能提升访问速度，但用户地域分布广，网速差异大。需借助**CDN（Content Delivery Network，内容分发网络）** 让用户就近获取内容，降低网络拥塞，提升响应速度与命中率。  
- 原理：将网站静态内容（图片、CSS、JavaScript文件等）复制到全球各地的服务器节点，用户请求时，CDN系统根据用户地理位置，自动将内容分发至最近节点。  
- 国内常见提供商：阿里云CDN、腾讯云CDN、百度云加速等。


## 3 缓存
缓存是高并发系统的核心技术之一，主要分为两类：
1. **应用服务器内存缓存（二级缓存）**：性能好，但多服务器节点部署时易出现数据不一致。  
2. **分布式缓存（中间件）**：如Redis、Memcached，虽性能略逊于二级缓存，但可避免多节点数据不一致问题。  

### 缓存用法与问题
- 核心作用：减轻数据库访问压力，显著提升系统性能，部分场景会结合使用二级缓存与分布式缓存（如获取商品分类数据）。  
- 注意事项：引入缓存会带来新问题，如“数据库和缓存双向一致性问题”“缓存穿透、击穿和雪崩问题”，需结合业务场景使用，避免“为缓存而缓存”。


## 4 异步
高并发系统中，接口的非核心逻辑无需同步执行，可通过“核心逻辑同步、非核心逻辑异步”提升接口性能，常见异步方式有两种：

### 4.1 线程池
以“业务操作+发站内通知+记录操作日志”的接口为例，将“发站内通知”“记录操作日志”提交到单独线程池异步执行，仅同步处理核心业务操作，可快速提升接口性能。  
- 缺点：服务器重启或功能异常时，无法重试，可能丢失数据。

### 4.2 MQ（消息队列）
接口仅发送MQ消息到MQ服务器，不直接执行非核心逻辑；由MQ消费者消费消息时，再执行“发站内通知”“记录操作日志”。  
- 优点：发送MQ消息速度快，兼顾性能与数据可靠性，避免数据丢失。


## 5 多线程处理
高并发场景下，大量MQ消息可能因消费者消费速度慢导致消息积压，需通过**多线程消费消息**（如线程池消费）优化。  
- 配置建议：核心线程数、最大线程数、队列大小、线程回收时间需设为可配置，便于根据实际情况动态调整。  
- 注意事项：多线程消费可能破坏消息顺序，若业务需保证消息顺序，需额外设计解决方案。


## 6 分库分表
系统发展到一定阶段，数据库会因“并发请求多（占用连接资源）”“数据量大（查询耗时）”成为瓶颈，需通过**分库分表**解决。

### 核心逻辑
通过路由算法（如id取模、id区间范围、一致性hash）将数据分配到不同库表，例如“用户库拆分为3个库，每个库包含4张用户表”，请求时先按用户id路由到目标库，再定位到目标表。

### 分库与分表的区别
| 操作   | 解决的问题                                                                 |
|--------|----------------------------------------------------------------------------|
| 分库   | 数据库连接资源不足、磁盘IO性能瓶颈                                         |
| 分表   | 单表数据量大导致查询耗时（即使走索引）、SQL执行消耗CPU资源                 |
| 分库分表 | 同时解决连接不足、IO瓶颈、查询耗时、CPU消耗等问题                           |

### 场景选择
- 并发大、数据量小：仅分库；  
- 并发小、数据量大：仅分表；  
- 并发大且数据量大：分库分表。


## 7 池化技术
池化技术是“多例设计模式”的体现，核心是通过“预先创建资源、缓存复用”减少资源创建/销毁的耗时，常见于数据库连接池、线程池等场景。  
以数据库连接池为例：创建数据库连接耗时耗资源，预先创建一批连接存入集合，使用时直接从集合获取，用完后归还，避免重复创建，提升系统性能。  
- 常用数据库连接池：Druid、C3P0、Hikari、DBCP等。


## 8 读写分离
多数系统遵循“二八原则”（80%读请求、20%写请求），若读写请求均访问同一数据库，会抢占连接资源、相互影响，需通过**主从读写分离架构**优化。

### 架构演进
1. **一主一从**：写请求指向主库（master），主库写完后异步同步数据到从库（slave），读请求指向从库；  
2. **一主多从**：若主库挂了，可将任一从库升级为新主库，剩余从库作为新主库的从库，解决“新主库扛不住读写请求”的问题；后续可根据读请求量扩展为“一主三从、一主四从”等。


## 9 索引
高并发系统中，用户频繁查询数据，**索引**是提升SQL查询速度的关键，但需合理设计与优化：  
- 注意事项：索引并非越多越好，插入数据时需为索引分配额外资源，会损耗插入性能；需根据业务场景权衡“查询性能”与“写入性能”。  
- 优化方向：  
  1. 将多个单索引改为联合索引；  
  2. 删除无用索引；  
  3. 使用`explain`分析SQL执行计划，确认是否走索引；  
  4. 规避索引失效场景；  
  5. 必要时用`force index`强制SQL走指定索引。


## 10 批处理
若需从用户集合中查询数据库中已存在的用户，循环单次查询（如50个用户循环查50次）会产生大量远程调用，耗时严重，需通过**批处理**优化：  
- 实现方式：提供“根据用户id集合批量查询”的接口，仅远程调用1次即可获取所有数据。  
- 注意事项：id集合大小需限制，建议每次请求记录数控制在500以内。


## 11 集群
为保证系统高可用，避免单节点故障导致服务不可用，需部署多个节点构成**集群**，常见集群类型包括应用服务器集群、数据库集群、中间件集群、文件服务器集群。  
以Redis集群为例：若用户缓存数据共40G，单节点内存仅16G，需部署3个Redis主节点（每节点存13.3G数据），并为每个主节点配置从节点做数据备份；请求时通过路由（用户id/ip）访问指定节点，主节点挂了可将从节点升级为新主节点，不影响用户使用。


## 12 负载均衡
多节点部署后，需通过**负载均衡**机制将用户请求分发到具体节点，确保节点负载均衡。

### 常用工具
- 服务器层面：Linux下的Nginx、LVS、Haproxy；  
- 微服务层面：SpringCloud中的Ribbon、OpenFegin、SpringCloud Loadbalancer；  
- 硬件层面：F5（基于交换机，性能好但价格高）。

### 常见负载均衡策略
1. **轮询**：按时间顺序分配请求，自动剔除故障节点；  
2. **权重（weight）**：权重越高的节点被分配请求的概率越大，适用于节点性能不均场景；  
3. **IP Hash**：按访问IP的Hash结果分配，确保同一用户固定访问同一节点，可解决Session共享问题；  
4. **最少连接数**：将请求转发给连接数少的节点，避免“长耗时请求导致节点负载过高”；  
5. **最短响应时间**：优先将请求分配给响应时间短的节点。


## 13 限流
为保证系统稳定性（尤其秒杀系统），需对请求量做**限流**，避免非法请求占用资源，常用限流方式如下：

| 限流类型       | 实现逻辑                                                                 | 优缺点                                                                 |
|----------------|--------------------------------------------------------------------------|------------------------------------------------------------------------|
| 同一用户限流   | 限制单个用户id的请求频次（如每分钟最多5次接口请求）                       | 精准限制单个用户，但无法应对“模拟多用户请求”场景                       |
| 同一IP限流     | 限制单个IP的请求频次（如每分钟最多5次接口请求）                           | 可应对多用户模拟请求，但可能误杀“同一出口IP下的正常用户”（如公司/网吧） |
| 接口限流       | 限制接口总请求次数                                                       | 保障系统稳定，但可能因非法请求占满额度，影响正常用户访问               |
| 加验证码       | 用户请求前需输入验证码，服务端校验通过才允许后续操作，验证码一次性使用     | 精准度高、无差杀，普通验证码易破解，移动滑块验证码更安全（主流选择）   |


## 14 服务降级
为合理利用服务器资源，需保留核心功能、屏蔽/下线非核心功能，即**服务降级**，关键设计点包括：  
1. **预留降级开关**：在分布式配置中心（如Apollo）配置非核心功能的开关（如商品评论功能），需降级时关闭开关；  
2. **设计兜底方案**：如分类查询接口优先从Redis获取数据，Redis故障时从Apollo获取默认分类数据；  
3. **常用中间件**：Hystrix（Netflix开源，熔断降级）、Sentinel（阿里开源，支持熔断降级与系统负载保护）。


## 15 故障转移
若应用服务器节点假死（如CPU使用率100%、内存溢出），会导致用户请求超时，需建立**故障转移**机制：  
- 检测逻辑：监控接口超时、CPU/内存异常，自动重启故障节点的应用；  
- 微服务场景：结合Ribbon（负载均衡，设置请求超时与健康检查，自动转发请求到可用节点）与Hystrix（熔断，故障率超阈值或请求超时后切换到备用服务）。


## 16 异地多活
为应对机房级故障（如断电、地震），需将系统部署到多个机房，实现**异地多活**：  
- 案例：游戏登录系统部署在深圳、天津、成都机房，流量分配为40%、30%、30%，单个机房故障时，流量自动分配到其他机房；  
- 核心难点：多机房数据同步，需保证数据一致性。


## 17 压测
高并发系统上线前必须做**压力测试**，确保系统能承受预期请求量：  
1. **预估与部署**：根据预估生产请求量（如10000 QPS），结合单节点最大支持QPS（如1000 QPS），确定部署节点数；为应对突发流量，建议按预估量的3倍部署（如10000 QPS需部署30个节点）；  
2. **环境选择**：Dev/Test环境仅能测趋势，需在Pre环境或与生产配置一致的专用压测环境中获取真实数据；  
3. **常用工具**：开源工具（Jemter、LoaderRunnder、Locust）、收费工具（阿里PTS）。


## 18 监控
为及时发现系统/SQL问题，需搭建**监控系统**，业界常用开源工具为Prometheus（支持监控与预警）：  
1. **监控维度**：接口响应时间、第三方服务调用耗时、慢查询SQL耗时、CPU/内存/磁盘使用率、数据库连接数等；  
2. **作用**：通过监控数据排查问题（如数据库连接池占用过高，可能是“连接未关闭”或“并发量过大”导致）。


## 额外思考
高并发系统还需考虑安全与弹性问题，例如：  
- 应对“不断换IP刷接口”“缓存雪崩”“DDoS攻击”；  
- 设计动态扩容机制，应对突发高并发。
